name: Deploy Streamlit App to GCP

on:
  push:
    paths:
      - 'UI/**'
    branches:
      - feature/UI-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the code
      uses: actions/checkout@v2

    - name: Set up Google Cloud authentication
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

    - name: Configure Docker for Google Cloud
      run: |
        gcloud auth configure-docker

    - name: Ensure GCR repository exists
      run: |
        REPO_LOCATION="us"
        PROJECT_ID="medscript-437117"
        REPO_NAME="gcr.io"
        
        # Check if repository exists
        REPO_EXISTS=$(gcloud artifacts repositories list \
          --filter="name~${REPO_NAME}" \
          --format="value(name)" \
          --location=${REPO_LOCATION})
        
        if [[ -z "$REPO_EXISTS" ]]; then
          echo "Repository does not exist. Creating..."
          gcloud artifacts repositories create $REPO_NAME \
            --repository-format=docker \
            --location=$REPO_LOCATION \
            --description="Docker repository for Streamlit app"
        else
          echo "Repository exists: $REPO_EXISTS"
        fi

    - name: Build Docker image
      run: |
        docker buildx build --platform linux/amd64 -f UI/Dockerfile -t gcr.io/medscript-437117/streamlit-app:latest UI

    - name: Push Docker image to Google Container Registry
      run: |
        docker push gcr.io/medscript-437117/streamlit-app:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy streamlit-app \
          --image gcr.io/medscript-437117/streamlit-app:latest \
          --platform managed \
          --region us-central1 \
          --allow-unauthenticated
